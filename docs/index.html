<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>作物病害風險儀表板（Demo）</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,.05); }
    #chartWrap { padding: 8px 8px 0 8px; }
    small.muted { color:#6b7280 }
    select, button { padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; }
    .legend-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <h2>作物病害風險儀表板（Demo）</h2>
  <div class="row card" style="gap:16px;">
    <div>站號：<code id="stationCode">讀取中…</code></div>
    <label>時間範圍
      <select id="range">
        <option value="24h">最近 24 小時</option>
        <option value="7d" selected>最近 7 天</option>
        <option value="30d">最近 30 天</option>
      </select>
    </label>
    <span class="muted">規則：<span class="legend-dot" style="background:#34d399"></span>低風險（T&lt;20 且 RH&lt;50）、
      <span class="legend-dot" style="background:#fde047"></span>中風險（20≤T&lt;28 且 50≤RH&lt;80）、
      <span class="legend-dot" style="background:#ef4444"></span>高風險（T≥28 且 RH≥80）</span>
  </div>

  <div id="chartWrap" class="card">
    <canvas id="riskChart" height="120"></canvas>
  </div>

  <small class="muted">資料來源：CWA OpenData（由快取 JSON 提供）；此頁僅示範。</small>

<script>
(async function () {
  // DOM 取用
  const rangeSel = document.getElementById('range');               // 你原本的「時間範圍」select
  const stationCodeEl = document.getElementById('stationCode');    // 顯示站號的 span
  const controlsRow = document.querySelector('.row.card');         // 上方白色那塊容器
  const msgBox = document.getElementById('msg') || (()=>{          // 錯誤訊息容器（沒有就建一個）
    const d=document.createElement('div'); d.id='msg'; d.style.color='#dc2626';
    controlsRow.after(d); return d;
  })();

  // 動態加「站台」下拉
  const stationSel = document.createElement('select');
  stationSel.id = 'station';
  stationSel.style.marginRight = '8px';
  rangeSel.parentElement.before(stationSel);

  // 工具：用目前頁面當 base，組絕對路徑（避免相對路徑出錯）
  const urlFrom = p => new URL(p, location.href).toString();

  // 1) 讀站台清單
  let stations = [];
  try {
    const idx = await (await fetch(urlFrom('data/index.json'), {cache:'no-store'})).json();
    stations = idx.stations || [];
  } catch (e) {
    msgBox.textContent = '載入站台清單失敗：' + e;
    return;
  }
  if (!stations.length) {
    msgBox.textContent = '目前沒有任何站台資料（請確認 Actions 是否產出 docs/data/index.json）。';
    return;
  }

  // 2) 生選單（支援 ?sid= 查詢參數）
  const urlSid = (new URLSearchParams(location.search)).get('sid');
  stations.forEach((s, i) => {
    const opt = document.createElement('option');
    opt.value = s.sid;
    opt.textContent = `${s.city} ${s.town} ${s.name} (${s.sid})`;
    if ((urlSid && s.sid === urlSid) || (!urlSid && i === 0)) opt.selected = true;
    stationSel.appendChild(opt);
  });

  // 3) Chart.js + 風險色帶
  const riskBands = {
    id: 'riskBands',
    beforeDraw(chart){
      const {ctx, chartArea:{left,right,top,bottom,height}} = chart;
      ctx.save();
      ctx.fillStyle='rgba(52,211,153,0.65)'; ctx.fillRect(left,bottom-height/3,right-left,height/3);
      ctx.fillStyle='rgba(253,224,71,0.65)'; ctx.fillRect(left,bottom-2*height/3,right-left,height/3);
      ctx.fillStyle='rgba(239,68,68,0.65)'; ctx.fillRect(left,top,right-left,height/3);
      const x = chart.scales.x.getPixelForValue(new Date());
      ctx.strokeStyle='#2563eb'; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(x,top); ctx.lineTo(x,bottom); ctx.stroke();
      ctx.restore();
    }
  };

  const ctx = document.getElementById('riskChart');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { datasets: [{ label:'Risk', parsing:false, data:[], borderWidth:2, pointRadius:0, tension:.35 }]},
    options: {
      animation:false,
      scales:{
        x:{ type:'time', time:{ unit:'hour' }},
        y:{ min:1, max:3, ticks:{ callback: v => ({1:'Low',2:'Moderate',3:'High'}[v]||v) } }
      },
      plugins:{ legend:{display:false},
        tooltip:{ callbacks:{ label: ctx=>{
          const d=ctx.raw, label=d.risk===3?'High':(d.risk===2?'Moderate':'Low');
          return `${label} (T=${d.temp??'–'}°C, RH=${d.rh??'–'}%)`;
        }}}
      }
    },
    plugins:[riskBands]
  });

  // 4) 載資料 + 更新圖
  let raw = [];
  function riskIndex(t, h){
    if (t==null || h==null) return 1;
    if (t>=28 && h>=80) return 3;
    if (t>=20 && t<28 && h>=50 && h<80) return 2;
    return 1;
  }
  function sliceByRange(arr, key){
    const end = Date.now(); let start = end;
    if (key==='24h') start -= 24*3600*1000;
    else if (key==='7d') start -= 7*24*3600*1000;
    else start -= 30*24*3600*1000;
    return arr.filter(d => d.t.getTime()>=start && d.t.getTime()<=end);
  }
  async function loadData(sid){
    msgBox.textContent = '';
    stationCodeEl.textContent = sid;
    try{
      const j = await (await fetch(urlFrom(`data/${sid}.json`), {cache:'no-store'})).json();
      raw = (j.series||[]).map(d => ({ t:new Date(d.t), temp:d.temp, rh:d.rh, rain:d.rain }));
      update(rangeSel.value);
    }catch(e){
      msgBox.textContent = `載入 ${sid}.json 失敗：` + e;
    }
  }
  function update(key){
    const rows = sliceByRange(raw, key).map(d => ({ x:d.t, y:riskIndex(d.temp,d.rh), risk:riskIndex(d.temp,d.rh), temp:d.temp, rh:d.rh }));
    chart.data.datasets[0].data = rows;
    chart.update();
  }

  // 5) 綁事件
  stationSel.addEventListener('change', ()=>loadData(stationSel.value));
  rangeSel.addEventListener('change', ()=>update(rangeSel.value));

  // 6) 初始化
  await loadData(stationSel.value);
})();
</script>

</body>
</html>
